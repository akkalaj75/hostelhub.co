<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HostelHub - Connect Anonymously</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1729 100%);
      color: #fff; font-family: 'Inter', sans-serif;
      min-height: 100vh; overflow-x: hidden;
    }
    .bg-animated {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(0, 210, 255, 0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(58, 123, 213, 0.15) 0%, transparent 50%);
      z-index: 0; animation: pulse 8s ease-in-out infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 0.5; } 50% { opacity: 0.8; } }
    nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: 20px 5%; backdrop-filter: blur(20px);
      background: rgba(10, 14, 39, 0.8); border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    .logo { font-size: 24px; font-weight: 800; background: linear-gradient(135deg, #00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-links { display: flex; gap: 30px; align-items: center; }
    .nav-links a { color: #aaa; text-decoration: none; font-weight: 500; transition: color 0.3s; }
    .nav-links a:hover { color: #00d2ff; }
    .nav-cta { background: linear-gradient(135deg, #00d2ff, #3a7bd5); padding: 12px 30px; border-radius: 30px; color: #fff !important; font-weight: 600; transition: transform 0.3s, box-shadow 0.3s; }
    .nav-cta:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.4); }
    .hero { position: relative; z-index: 1; padding: 150px 5% 80px; text-align: center; max-width: 1200px; margin: 0 auto; }
    .hero h1 { font-size: clamp(36px, 6vw, 72px); font-weight: 800; line-height: 1.1; margin-bottom: 20px; background: linear-gradient(135deg, #ffffff, #00d2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: fadeInUp 1s ease; }
    .hero p { font-size: clamp(18px, 2vw, 24px); color: #aaa; max-width: 700px; margin: 0 auto 40px; animation: fadeInUp 1s ease 0.2s both; }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .features { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 30px; padding: 60px 5%; max-width: 1200px; margin: 0 auto; position: relative; z-index: 1; }
    .feature-card { background: rgba(26, 26, 46, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 40px 30px; text-align: center; transition: all 0.4s; cursor: pointer; }
    .feature-card:hover { transform: translateY(-10px); border-color: rgba(0, 210, 255, 0.5); box-shadow: 0 20px 60px rgba(0, 210, 255, 0.2); }
    .feature-icon { font-size: 48px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(0, 210, 255, 0.5)); }
    .cta-section { text-align: center; padding: 80px 5%; position: relative; z-index: 1; }
    .cta-btn { display: inline-block; background: linear-gradient(135deg, #00d2ff, #3a7bd5); padding: 20px 60px; border-radius: 50px; color: #fff; font-size: 20px; font-weight: 700; text-decoration: none; transition: all 0.3s; border: none; cursor: pointer; box-shadow: 0 10px 40px rgba(0, 210, 255, 0.3); }
    .cta-btn:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 20px 60px rgba(0, 210, 255, 0.5); }
    .app-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 1000; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
    .app-modal.active { display: flex; }
    .app-container { background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); border-radius: 30px; padding: 50px 40px; width: 100%; max-width: 500px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5); position: relative; animation: slideUp 0.5s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    .close-btn { position: absolute; top: 20px; right: 20px; font-size: 30px; cursor: pointer; color: #888; transition: color 0.3s; background: none; border: none; line-height: 1; padding: 0; width: 30px; height: 30px; }
    .close-btn:hover { color: #ff6b6b; }
    input, select, button, textarea { width: 100%; padding: 16px 20px; margin: 12px 0; border-radius: 15px; font-size: 16px; font-family: 'Inter', sans-serif; border: 1px solid rgba(255,255,255,0.1); background: rgba(22, 33, 62, 0.5); color: #fff; transition: all 0.3s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #00d2ff; box-shadow: 0 0 20px rgba(0, 210, 255, 0.2); }
    button { background: linear-gradient(135deg, #00d2ff, #3a7bd5); border: none; font-weight: 600; cursor: pointer; box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3); }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0, 210, 255, 0.5); }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: rgba(68, 68, 68, 0.5); backdrop-filter: blur(10px); }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ff4444); }
    .btn-warning { background: linear-gradient(135deg, #ffa500, #ff8c00); }
    .btn-report { background: linear-gradient(135deg, #ff4444, #cc0000); font-size: 14px; }
    .subtitle { color: #888; font-size: 15px; margin-bottom: 30px; }
    #status { margin-top: 20px; font-size: 15px; min-height: 24px; color: #ffd43b; font-weight: 500; }
    .safety-note { font-size: 13px; color: #666; margin-top: 15px; line-height: 1.6; }
    .warning { color: #ff6b6b; }
    .comm-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0; }
    .comm-type { padding: 20px 15px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.1); background: rgba(22, 33, 62, 0.3); cursor: pointer; transition: all 0.3s; text-align: center; }
    .comm-type:hover { border-color: rgba(0, 210, 255, 0.5); transform: translateY(-3px); }
    .comm-type.active { border-color: #00d2ff; background: rgba(0, 210, 255, 0.1); box-shadow: 0 5px 20px rgba(0, 210, 255, 0.2); }
    .comm-type-icon { font-size: 32px; margin-bottom: 8px; }
    .comm-type-label { font-size: 14px; font-weight: 600; }
    .interests-section { margin: 25px 0; text-align: left; }
    .interests-label { font-size: 14px; color: #888; margin-bottom: 12px; font-weight: 500; }
    .interests-input { display: flex; gap: 10px; margin-bottom: 12px; }
    .interests-input input { flex: 1; margin: 0; }
    .interests-input button { width: auto; padding: 16px 24px; margin: 0; }
    .interest-tags { display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px; }
    .interest-tag { background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: #fff; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 10px; }
    .interest-tag .remove { cursor: pointer; font-size: 18px; font-weight: bold; }
    #video-container, #chat-container { display: none; margin-top: 20px; }
    #videos { display: flex; flex-direction: column; gap: 15px; position: relative; border-radius: 20px; overflow: hidden; }
    #local-video, #remote-video { width: 100%; background: #000; border-radius: 20px; object-fit: cover; }
    #remote-video { height: 350px; }
    #local-video { height: 140px; border: 3px solid #00d2ff; position: absolute; bottom: 15px; right: 15px; width: 160px; z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    #chat-messages { height: 400px; overflow-y: auto; background: rgba(22, 33, 62, 0.3); border-radius: 20px; padding: 20px; margin-bottom: 15px; text-align: left; }
    .message { margin-bottom: 15px; padding: 12px 16px; border-radius: 15px; max-width: 80%; word-wrap: break-word; animation: messageIn 0.3s ease; }
    @keyframes messageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message.local { background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: #fff; margin-left: auto; text-align: right; }
    .message.remote { background: rgba(42, 42, 62, 0.8); color: #fff; }
    .message.system { background: transparent; color: #666; font-size: 13px; text-align: center; max-width: 100%; }
    #chat-input-area { display: flex; gap: 12px; }
    #chat-input { flex: 1; margin: 0; }
    #send-btn { width: auto; padding: 16px 30px; margin: 0; }
    .video-controls, .chat-controls { display: flex; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
    .video-controls button, .chat-controls button { flex: 1; min-width: 90px; font-size: 14px; }
    .connection-status { font-size: 13px; padding: 12px; border-radius: 12px; margin-top: 15px; background: rgba(42, 42, 62, 0.5); backdrop-filter: blur(10px); font-weight: 500; }
    .quality-good { color: #4ade80; }
    .quality-fair { color: #ffd43b; }
    .quality-poor { color: #ff6b6b; }
    .screen { display: none; }
    .screen.active { display: block; }
    .verify-notice, .stranger-info { background: rgba(42, 42, 62, 0.5); backdrop-filter: blur(10px); padding: 18px; border-radius: 15px; margin: 18px 0; font-size: 14px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1); }
    .stranger-interests { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; }
    .stranger-interests .tag { background: rgba(74, 222, 128, 0.2); color: #4ade80; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px); padding: 40px; border-radius: 25px; max-width: 450px; width: 100%; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5); }
    .modal-content h3 { margin-bottom: 25px; color: #00d2ff; font-size: 24px; }
    .modal-content textarea { min-height: 120px; margin: 18px 0; }
    .modal-buttons { display: flex; gap: 12px; margin-top: 25px; }
    .modal-buttons button { flex: 1; margin: 0; }
    @media (max-width: 768px) {
      nav { padding: 15px 5%; }
      .nav-links { display: none; }
      .hero { padding: 120px 5% 60px; }
      .hero h1 { font-size: 36px; }
      .features { grid-template-columns: 1fr; }
      .app-container { padding: 30px 25px; }
      #remote-video { height: 250px; }
      #local-video { width: 120px; height: 100px; }
    }
  </style>
</head>
<body>
  <div class="bg-animated"></div>
  <nav>
    <div class="logo">HostelHub</div>
    <div class="nav-links">
      <a href="#features" onclick="scrollToFeatures(event)">Features</a>
      <a href="#about" onclick="scrollToSection(event, 'cta-section')">About</a>
      <a href="#" class="nav-cta" onclick="event.preventDefault(); openApp();">Get Started</a>
    </div>
  </nav>
  <section class="hero">
    <h1>Connect with College Students Anonymously</h1>
    <p>Video chat, voice call, or text with students from your college. Safe, anonymous, and fun.</p>
    <button class="cta-btn" onclick="openApp()">Start Matching Now</button>
  </section>
  <section class="features" id="features">
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Video</div><h3>Video & Voice</h3><p>High-quality calls</p></div>
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Anonymous</div><h3>Anonymous Matching</h3><p>Verified students only</p></div>
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Chat</div><h3>Text Chat</h3><p>Auto-save feature</p></div>
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Shield</div><h3>Safe & Secure</h3><p>Report & block</p></div>
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Skip</div><h3>Skip Anytime</h3><p>Omegle-style</p></div>
    <div class="feature-card" onclick="openApp()"><div class="feature-icon">Target</div><h3>Interest Matching</h3><p>Find common hobbies</p></div>
  </section>
  <section class="cta-section" id="cta-section">
    <h2 style="font-size: 42px; margin-bottom: 20px;">Ready to make new friends?</h2>
    <p style="color: #888; margin-bottom: 40px; font-size: 18px;">Join thousands of students</p>
    <button class="cta-btn" onclick="openApp()">Launch HostelHub</button>
  </section>

  <div id="appModal" class="app-modal">
    <div class="app-container">
      <button class="close-btn" onclick="closeApp()">×</button>
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 32px; margin-bottom: 10px;">HostelHub</h1>
        <p class="subtitle">Connect with students anonymously</p>
      </div>

      <!-- Login -->
      <div id="login-screen" class="screen active">
        <input id="email" type="email" placeholder="your.email@gmail.com" />
        <input id="password" type="password" placeholder="Password (6+ chars)" />
        <button id="signupBtn">Sign Up</button>
        <button id="loginBtn" class="btn-secondary">Login</button>
        <button id="forgotPasswordBtn" class="btn-secondary" style="font-size: 13px; padding: 12px;">Forgot Password?</button>
        <div class="verify-notice" style="display: none;" id="verify-notice">Verification email sent! Check inbox.</div>
        <div class="verify-notice" style="display: none;" id="reset-notice">Password reset email sent!</div>
        <div class="safety-note">Any email • Anonymous • No info shared</div>
      </div>

      <!-- Setup -->
      <div id="setup-screen" class="screen">
        <p class="subtitle">Logged in as: <span id="user-email"></span></p>
        <div class="comm-types">
          <div class="comm-type active" data-type="video"><div class="comm-type-icon">Video</div><div class="comm-type-label">Video</div></div>
          <div class="comm-type" data-type="voice"><div class="comm-type-icon">Microphone</div><div class="comm-type-label">Voice</div></div>
          <div class="comm-type" data-type="chat"><div class="comm-type-icon">Chat</div><div class="comm-type-label">Chat</div></div>
        </div>
        <select id="gender"><option value="">Gender</option><option value="men">Men</option><option value="women">Women</option><option value="other">Other</option></select>
        <select id="college">
          <option value="">College</option>
          <option value="IIT Delhi">IIT Delhi</option>
          <option value="IIT Bombay">IIT Bombay</option>
          <option value="JNTUK">JNTUK</option>
          <option value="KL University">KL University</option>
          <option value="VIT AP">VIT AP</option>
          <option value="Delhi University">Delhi University</option>
          <option value="Other">Other</option>
          <option value="ANY">Match with Anyone</option>
        </select>
        <div class="interests-section">
          <div class="interests-label">Interests (max 5):</div>
          <div class="interests-input">
            <input id="interest-input" type="text" placeholder="cricket, coding..." maxlength="20" />
            <button id="add-interest-btn">Add</button>
          </div>
          <div class="interest-tags" id="interest-tags"></div>
        </div>
        <button id="findBtn">Find Match</button>
        <button id="logoutBtn" class="btn-secondary">Logout</button>
        <div class="safety-note">Matched anonymously. <span class="warning">Never share contact info.</span></div>
      </div>

      <div id="status"></div>

      <!-- Video -->
      <div id="video-container">
        <div class="stranger-info" id="stranger-info"></div>
        <div class="connection-status" id="connection-status">Connection: <span id="quality">Connecting...</span></div>
        <div id="videos">
          <video id="remote-video" autoplay playsinline></video>
          <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div class="video-controls">
          <button id="muteBtn">Mute</button>
          <button id="videoBtn">Off</button>
          <button id="skipBtn" class="btn-warning">Skip</button>
          <button id="reportBtn" class="btn-report">Report</button>
          <button id="endCall" class="btn-danger">End</button>
        </div>
        <div class="safety-note"><span class="warning">Warning</span> Report inappropriate behavior.</div>
      </div>

      <!-- Chat -->
      <div id="chat-container">
        <div class="stranger-info" id="stranger-info-chat"></div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
          <input id="chat-input" type="text" placeholder="Type a message..." maxlength="500" />
          <button id="send-btn">Send</button>
        </div>
        <div class="chat-controls">
          <button id="skipBtnChat" class="btn-warning">Skip</button>
          <button id="reportBtnChat" class="btn-report">Report</button>
          <button id="saveChatBtn" style="background: linear-gradient(135deg, #4ade80, #22c55e);">Save</button>
          <button id="endChat" class="btn-danger">End</button>
        </div>
        <div class="safety-note"><span class="warning">Warning</span> Never share personal info.</div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <h3>Report User</h3>
      <p style="color: #888; font-size: 14px;">Why are you reporting?</p>
      <select id="reportReason">
        <option value="">Select reason</option>
        <option value="inappropriate">Inappropriate</option>
        <option value="harassment">Harassment</option>
        <option value="spam">Spam</option>
        <option value="contact-sharing">Contact sharing</option>
        <option value="underage">Underage</option>
        <option value="other">Other</option>
      </select>
      <textarea id="reportDetails" placeholder="Details (optional)"></textarea>
      <div class="modal-buttons">
        <button id="cancelReport" class="btn-secondary">Cancel</button>
        <button id="submitReport" class="btn-danger">Submit</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB_gNArL-vud6HhtWXnwVf6KMAXTRqfAk4",
      authDomain: "hostelhub-b11fd.firebaseapp.com",
      projectId: "hostelhub-b11fd",
      storageBucket: "hostelhub-b11fd.appspot.com",
      messagingSenderId: "935653838481",
      appId: "1:935653838481:web:e65ad37e0f6e91ff3ef930",
      measurementId: "G-KMHEWDN748"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null, localStream = null, pc = null, callId = null, remoteUid = null;
    let matchListener = null, callListener = null, candidateListener = null, chatListener = null;
    let isAudioMuted = false, isVideoOff = false, commType = 'video', userInterests = [], blockedUsers = [], chatHistory = [];

    const appModal = document.getElementById('appModal');
    const loginScreen = document.getElementById('login-screen');
    const setupScreen = document.getElementById('setup-screen');
    const videoContainer = document.getElementById('video-container');
    const chatContainer = document.getElementById('chat-container');
    const statusEl = document.getElementById('status');
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const reportModal = document.getElementById('reportModal');

    function openApp() { appModal.classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeApp() { appModal.classList.remove('active'); document.body.style.overflow = ''; }
    window.openApp = openApp; window.closeApp = closeApp;

    async function loadUserProfile() {
      if (!currentUser) return;
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        if (doc.exists) { blockedUsers = doc.data().blockedUsers || []; updateBlockedList(); }
      } catch (e) { console.error(e); }
    }

    function updateBlockedList() {
      const section = document.getElementById('blocked-section') || document.createElement('div');
      section.id = 'blocked-section'; section.style.display = blockedUsers.length ? 'block' : 'none';
      const list = document.getElementById('blocked-list') || document.createElement('div');
      list.id = 'blocked-list';
      list.innerHTML = blockedUsers.map(id => `<div class="blocked-user"><span>User ${id.slice(0,8)}...</span><span class="unblock-btn" onclick="unblockUser('${id}')">Unblock</span></div>`).join('');
      section.appendChild(list);
      const setup = document.getElementById('setup-screen');
      if (!setup.querySelector('#blocked-section')) setup.appendChild(section);
    }

    async function blockUser(id) {
      if (!blockedUsers.includes(id)) {
        blockedUsers.push(id);
        await db.collection('users').doc(currentUser.uid).set({ blockedUsers }, { merge: true });
        updateBlockedList();
      }
    }

    window.unblockUser = async (id) => {
      blockedUsers = blockedUsers.filter(u => u !== id);
      await db.collection('users').doc(currentUser.uid).set({ blockedUsers }, { merge: true });
      updateBlockedList();
    };

    document.getElementById('reportBtn')?.addEventListener('click', () => reportModal.classList.add('active'));
    document.getElementById('reportBtnChat')?.addEventListener('click', () => reportModal.classList.add('active'));
    document.getElementById('cancelReport').onclick = () => reportModal.classList.remove('active');
    document.getElementById('submitReport').onclick = async () => {
      const reason = document.getElementById('reportReason').value;
      if (!reason) return alert('Select a reason');
      await db.collection('reports').add({
        reportedBy: currentUser.uid, reportedUser: remoteUid, reason,
        details: document.getElementById('reportDetails').value,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(), callId
      });
      await blockUser(remoteUid);
      reportModal.classList.remove('active');
      showStatus('Reported & blocked', 'success');
      setTimeout(skipMatch, 2000);
    };

    document.getElementById('saveChatBtn').onclick = () => {
      if (!chatHistory.length) return showStatus('No messages to save', 'warning');
      const text = chatHistory.map(m => `[${m.time}] ${m.from}: ${m.text}`).join('\n');
      const blob = new Blob([text], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `chat-${Date.now()}.txt`;
      a.click();
      showStatus('Saved!', 'success');
    };

    document.querySelectorAll('.comm-type').forEach(el => el.onclick = () => {
      document.querySelectorAll('.comm-type').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
      commType = el.dataset.type;
    });

    document.getElementById('add-interest-btn').onclick = () => {
      const val = document.getElementById('interest-input').value.trim().toLowerCase();
      if (val && userInterests.length < 5 && !userInterests.includes(val)) {
        userInterests.push(val);
        updateInterestTags();
        document.getElementById('interest-input').value = '';
      }
    };

    function updateInterestTags() {
      document.getElementById('interest-tags').innerHTML = userInterests.map(i => 
        `<div class="interest-tag">${i} <span class="remove" onclick="userInterests=userInterests.filter(x=>x!=='${i}');updateInterestTags();">×</span></div>`
      ).join('');
    }

    auth.onAuthStateChanged(async user => {
      if (user && user.emailVerified) {
        currentUser = user;
        await loadUserProfile();
        showSetupScreen();
      } else if (user) {
        showStatus('Verify email first', 'warning');
        setTimeout(() => auth.signOut(), 3000);
      } else {
        showLoginScreen();
      }
    });

    document.getElementById('signupBtn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      if (!email.includes('@') || pass.length < 6) return showStatus('Invalid input', 'error');
      try {
        const res = await auth.createUserWithEmailAndPassword(email, pass);
        await res.user.sendEmailVerification();
        document.getElementById('verify-notice').style.display = 'block';
        showStatus('Check email!', 'success');
        setTimeout(() => auth.signOut(), 3000);
      } catch (e) { showStatus(e.message, 'error'); }
    };

    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value;
      try { await auth.signInWithEmailAndPassword(email, pass); }
      catch (e) { showStatus(e.message, 'error'); }
    };

    document.getElementById('forgotPasswordBtn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      if (!email.includes('@')) return showStatus('Enter email', 'error');
      try {
        await auth.sendPasswordResetEmail(email);
        document.getElementById('reset-notice').style.display = 'block';
        showStatus('Reset email sent!', 'success');
      } catch (e) { showStatus(e.message, 'error'); }
    };

    document.getElementById('findBtn').onclick = async () => {
      const gender = document.getElementById('gender').value;
      const college = document.getElementById('college').value;
      if (!gender || !college) return showStatus('Select gender & college', 'error');
      try {
        showStatus('Finding...', 'info');
        document.getElementById('findBtn').disabled = true;
        const uid = currentUser.uid;
        await db.collection('waiting').doc(uid).set({
          userId: uid, email: currentUser.email, college, gender, commType,
          interests: userInterests,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        await findMatch(uid, college, gender);
      } catch (e) { showStatus(e.message, 'error'); document.getElementById('findBtn').disabled = false; }
    };

    async function findMatch(uid, college, gender) {
      let attempts = 0, matched = false;
      const query = college === 'ANY' 
        ? db.collection('waiting').where('commType', '==', commType)
        : db.collection('waiting').where('college', '==', college).where('gender', '==', gender).where('commType', '==', commType);

      matchListener = query.onSnapshot(async snap => {
        attempts++;
        const others = snap.docs.filter(d => d.id !== uid && !blockedUsers.includes(d.id));
        showStatus(`Finding... (${others.length} waiting)`, 'info');
        if (others.length && !matched) {
          matched = true;
          const match = others[0];
          remoteUid = match.id;
          callId = [uid, remoteUid].sort().join('_');
          await Promise.all([
            db.collection('waiting').doc(uid).delete(),
            db.collection('waiting').doc(remoteUid).delete()
          ]);
          if (matchListener) { matchListener(); matchListener = null; }
          showStrangerInfo(match.data().interests || []);
          showStatus('Match found!', 'success');
          await new Promise(r => setTimeout(r, 500));
          commType === 'chat' ? await startChat() : await startCall(uid < remoteUid);
        } else if (attempts >= 60) {
          if (matchListener) matchListener();
          await db.collection('waiting').doc(uid).delete().catch(() => {});
          showStatus('No match. Try again.', 'error');
          document.getElementById('findBtn').disabled = false;
        }
      });
    }

    function showStrangerInfo(interests) {
      const common = interests.filter(i => userInterests.includes(i));
      let html = `<div>Connected with stranger from ${document.getElementById('college').value}</div>`;
      if (common.length) html += `<div class="stranger-interests">Common: ${common.map(i=>`<span class="tag">${i}</span>`).join('')}</div>`;
      else if (interests.length) html += `<div class="stranger-interests">Their: ${interests.map(i=>`<span class="tag">${i}</span>`).join('')}</div>`;
      document.getElementById('stranger-info').innerHTML = html;
      document.getElementById('stranger-info-chat').innerHTML = html;
    }

    async function startChat() {
      chatContainer.style.display = 'block'; setupScreen.style.display = 'none';
      chatHistory = []; addSystemMessage('Connected! Say hi');
      chatListener = db.collection('calls').doc(callId).collection('messages')
        .orderBy('timestamp').onSnapshot(snap => {
          snap.docChanges().forEach(c => {
            if (c.type === 'added' && c.doc.data().from !== currentUser.uid) {
              const msg = c.doc.data();
              addMessage(msg.text, 'remote');
              chatHistory.push({ from: 'Stranger', text: msg.text, time: new Date().toLocaleTimeString() });
            }
          });
        });
    }

    document.getElementById('send-btn').onclick = sendMessage;
    chatInput.onkeypress = e => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(); } };

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      if (containsContactInfo(text)) return addSystemMessage('Contact info blocked');
      addMessage(text, 'local');
      chatHistory.push({ from: 'You', text, time: new Date().toLocaleTimeString() });
      chatInput.value = '';
      await db.collection('calls').doc(callId).collection('messages').add({
        text, from: currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function containsContactInfo(t) {
      return /\d{10}|instagram|whatsapp|snapchat|facebook/i.test(t);
    }

    function addMessage(text, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'message system';
      div.textContent = text;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function startCall(isInitiator) {
      try {
        const constraints = commType === 'video' ? { video: { width: 640, height: 480 }, audio: true } : { video: false, audio: true };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        if (commType === 'voice') { localVideo.style.display = remoteVideo.style.display = 'none'; }

        pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
          ]
        });

        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => { if (e.streams[0]) { remoteVideo.srcObject = e.streams[0]; remoteVideo.play(); } };
        pc.onicecandidate = e => { if (e.candidate) db.collection('calls').doc(callId).collection('candidates').add({ candidate: e.candidate.toJSON(), from: currentUser.uid, timestamp: firebase.firestore.FieldValue.serverTimestamp() }); };
        pc.onconnectionstatechange = () => updateConnectionQuality(pc.connectionState);

        candidateListener = db.collection('calls').doc(callId).collection('candidates').onSnapshot(snap => {
          snap.docChanges().forEach(async c => {
            if (c.type === 'added' && c.doc.data().from !== currentUser.uid) {
              await pc.addIceCandidate(new RTCIceCandidate(c.doc.data().candidate));
            }
          });
        });

        callListener = db.collection('calls').doc(callId).onSnapshot(async snap => {
          const data = snap.data();
          if (!data) return;
          if (!isInitiator && data.offer && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await db.collection('calls').doc(callId).update({ answer: { type: answer.type, sdp: answer.sdp } });
          }
          if (isInitiator && data.answer && !pc.currentRemoteDescription) {
            await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
          }
        });

        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          await db.collection('calls').doc(callId).set({
            offer: { type: offer.type, sdp: offer.sdp },
            initiator: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        showVideoScreen();
      } catch (e) { showStatus('Camera/mic error: ' + e.message, 'error'); await cleanup(); }
    }

    document.getElementById('muteBtn').onclick = () => {
      if (!localStream) return;
      isAudioMuted = !isAudioMuted;
      localStream.getAudioTracks().forEach(t => t.enabled = !isAudioMuted);
      document.getElementById('muteBtn').textContent = isAudioMuted ? 'Unmute' : 'Mute';
    };

    document.getElementById('videoBtn').onclick = () => {
      if (!localStream) return;
      isVideoOff = !isVideoOff;
      localStream.getVideoTracks().forEach(t => t.enabled = !isVideoOff);
      document.getElementById('videoBtn').textContent = isVideoOff ? 'On' : 'Off';
    };

    document.getElementById('skipBtn').onclick = skipMatch;
    document.getElementById('skipBtnChat').onclick = skipMatch;

    async function skipMatch() {
      showStatus('Finding new match...', 'info');
      await cleanup();
      document.getElementById('findBtn').click();
    }

    document.getElementById('endCall').onclick = async () => { await cleanup(); showSetupScreen(); };
    document.getElementById('endChat').onclick = async () => { await cleanup(); showSetupScreen(); };

    async function cleanup() {
      [matchListener, callListener, candidateListener, chatListener].forEach(l => { if (l) try { l(); } catch(e) {} });
      matchListener = callListener = candidateListener = chatListener = null;
      if (pc) { pc.close(); pc = null; }
      if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
      if (currentUser && callId) {
        const callRef = db.collection('calls').doc(callId);
        await Promise.all([
          (await callRef.collection('candidates').get()).docs.map(d => d.ref.delete()),
          (await callRef.collection('messages').get()).docs.map(d => d.ref.delete()),
          callRef.delete(),
          db.collection('waiting').doc(currentUser.uid).delete().catch(() => {})
        ]).catch(() => {});
      }
      callId = remoteUid = null;
      isAudioMuted = isVideoOff = false;
      chatMessages.innerHTML = ''; chatHistory = [];
      document.getElementById('findBtn').disabled = false;
    }

    function updateConnectionQuality(state) {
      const el = document.getElementById('quality');
      if (state === 'connected') { el.textContent = 'Connected'; el.className = 'quality-good'; }
      else if (state === 'connecting') { el.textContent = 'Connecting...'; el.className = 'quality-fair'; }
      else { el.textContent = 'Lost'; el.className = 'quality-poor'; showStatus('Connection lost', 'error'); }
    }

    function showStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ade80' : '#ffd43b';
    }

    function showLoginScreen() { loginScreen.classList.add('active'); setupScreen.classList.remove('active'); videoContainer.style.display = chatContainer.style.display = 'none'; }
    function showSetupScreen() { loginScreen.classList.remove('active'); setupScreen.classList.add('active'); videoContainer.style.display = chatContainer.style.display = 'none'; document.getElementById('user-email').textContent = currentUser.email.split('@')[0]; }
    function showVideoScreen() { setupScreen.classList.remove('active'); videoContainer.style.display = 'block'; chatContainer.style.display = 'none'; }

    window.addEventListener('beforeunload', cleanup);
  </script>
</body>
</html>
