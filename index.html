<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Connect anonymously with college students through video, voice, or chat. Safe, verified, and fun.">
  <title>HostelHub - Connect with College Students Anonymously</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; }
    
    body {
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1729 100%);
      color: #fff; font-family: 'Inter', sans-serif;
      min-height: 100vh; overflow-x: hidden; position: relative;
    }

    .bg-animated {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(0, 210, 255, 0.15) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(58, 123, 213, 0.15) 0%, transparent 50%);
      z-index: 0; animation: pulse 8s ease-in-out infinite; pointer-events: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }

    nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: 20px 5%; backdrop-filter: blur(20px);
      background: rgba(10, 14, 39, 0.8); border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .logo {
      font-size: 24px; font-weight: 800;
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      cursor: pointer; position: relative; z-index: 101;
    }
    
    .nav-links {
      display: flex; gap: 30px; align-items: center;
      position: relative; z-index: 101;
    }
    
    .nav-links a {
      color: #aaa; text-decoration: none; font-weight: 500;
      transition: color 0.3s; cursor: pointer; position: relative; z-index: 101;
    }
    
    .nav-links a:hover { color: #00d2ff; }
    
    .nav-cta {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      padding: 12px 30px; border-radius: 30px; color: #fff !important;
      font-weight: 600; transition: transform 0.3s, box-shadow 0.3s;
      border: none; cursor: pointer; position: relative; z-index: 101;
    }
    
    .nav-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 210, 255, 0.4);
    }

    .menu-toggle {
      display: none; font-size: 28px; cursor: pointer; color: #fff;
      position: relative; z-index: 101;
    }

    .hero {
      position: relative; z-index: 1; padding: 150px 5% 80px;
      text-align: center; max-width: 1200px; margin: 0 auto;
    }
    
    .hero h1 {
      font-size: clamp(32px, 6vw, 72px); font-weight: 800;
      line-height: 1.1; margin-bottom: 20px;
      background: linear-gradient(135deg, #ffffff, #00d2ff);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      animation: fadeInUp 1s ease;
    }
    
    .hero p {
      font-size: clamp(16px, 2vw, 24px); color: #aaa;
      max-width: 700px; margin: 0 auto 40px;
      animation: fadeInUp 1s ease 0.2s both; line-height: 1.6;
    }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .features {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 30px; padding: 60px 5%; max-width: 1200px; margin: 0 auto;
      position: relative; z-index: 1;
    }
    
    .feature-card {
      background: rgba(26, 26, 46, 0.6); backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 20px;
      padding: 40px 30px; text-align: center; transition: all 0.4s;
      cursor: pointer; position: relative; z-index: 10;
    }
    
    .feature-card:hover {
      transform: translateY(-10px);
      border-color: rgba(0, 210, 255, 0.5);
      box-shadow: 0 20px 60px rgba(0, 210, 255, 0.2);
    }
    
    .feature-icon {
      font-size: 48px; margin-bottom: 20px;
      filter: drop-shadow(0 0 20px rgba(0, 210, 255, 0.5));
    }
    
    .feature-card h3 { font-size: 22px; margin-bottom: 15px; color: #fff; }
    .feature-card p { color: #888; font-size: 15px; line-height: 1.6; }

    .cta-section {
      text-align: center; padding: 80px 5%; position: relative; z-index: 1;
    }
    
    .cta-btn {
      display: inline-block;
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      padding: 20px 60px; border-radius: 50px; color: #fff;
      font-size: 20px; font-weight: 700; text-decoration: none;
      transition: all 0.3s; border: none; cursor: pointer;
      box-shadow: 0 10px 40px rgba(0, 210, 255, 0.3);
      position: relative; z-index: 10;
    }
    
    .cta-btn:hover {
      transform: translateY(-5px) scale(1.05);
      box-shadow: 0 20px 60px rgba(0, 210, 255, 0.5);
    }

    .app-modal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px);
      z-index: 1000; align-items: center; justify-content: center;
      padding: 20px; overflow-y: auto;
    }
    
    .app-modal.active { display: flex; }
    
    .app-container {
      background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(20px);
      border-radius: 30px; padding: 50px 40px;
      width: 100%; max-width: 500px;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
      position: relative; animation: slideUp 0.5s ease;
      margin: auto; z-index: 1001;
    }
    
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(50px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .close-btn {
      position: absolute; top: 20px; right: 20px;
      font-size: 30px; cursor: pointer; color: #888;
      transition: color 0.3s; background: none; border: none;
      line-height: 1; padding: 0; width: 30px; height: 30px; z-index: 1002;
    }
    
    .close-btn:hover { color: #ff6b6b; }

    input, select, button, textarea {
      width: 100%; padding: 16px 20px; margin: 12px 0;
      border-radius: 15px; font-size: 16px; font-family: 'Inter', sans-serif;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(22, 33, 62, 0.5); color: #fff;
      transition: all 0.3s; position: relative; z-index: 10;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none; border-color: #00d2ff;
      box-shadow: 0 0 20px rgba(0, 210, 255, 0.2);
    }
    
    button {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      border: none; font-weight: 600; cursor: pointer;
      box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3);
    }
    
    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 210, 255, 0.5);
    }
    
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    .btn-secondary {
      background: rgba(68, 68, 68, 0.5); backdrop-filter: blur(10px);
    }

    .subtitle { color: #888; font-size: 15px; margin-bottom: 30px; }
    #status { margin-top: 20px; font-size: 15px; min-height: 24px; color: #ffd43b; font-weight: 500; }
    .safety-note { font-size: 13px; color: #666; margin-top: 15px; line-height: 1.6; }
    .warning { color: #ff6b6b; }

    .comm-types {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 15px; margin: 25px 0;
    }
    
    .comm-type {
      padding: 20px 15px; border-radius: 15px;
      border: 2px solid rgba(255,255,255,0.1);
      background: rgba(22, 33, 62, 0.3); cursor: pointer;
      transition: all 0.3s; text-align: center;
      position: relative; z-index: 10;
    }
    
    .comm-type:hover { border-color: rgba(0, 210, 255, 0.5); transform: translateY(-3px); }
    .comm-type.active {
      border-color: #00d2ff;
      background: rgba(0, 210, 255, 0.1);
      box-shadow: 0 5px 20px rgba(0, 210, 255, 0.2);
    }
    
    .comm-type-icon { font-size: 32px; margin-bottom: 8px; }
    .comm-type-label { font-size: 14px; font-weight: 600; }

    .interests-section { margin: 25px 0; text-align: left; }
    .interests-label { font-size: 14px; color: #888; margin-bottom: 12px; font-weight: 500; }
    .interests-input { display: flex; gap: 10px; margin-bottom: 12px; }
    .interests-input input { flex: 1; margin: 0; }
    .interests-input button { width: auto; padding: 16px 24px; margin: 0; }
    
    .interest-tags { display: flex; flex-wrap: wrap; gap: 10px; min-height: 40px; }
    .interest-tag {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      color: #fff; padding: 8px 16px; border-radius: 25px;
      font-size: 13px; font-weight: 600;
      display: inline-flex; align-items: center; gap: 10px;
    }
    .interest-tag .remove { cursor: pointer; font-size: 18px; font-weight: bold; }

    .screen { display: none; }
    .screen.active { display: block; }

    .verify-notice {
      background: rgba(42, 42, 62, 0.5); backdrop-filter: blur(10px);
      padding: 18px; border-radius: 15px; margin: 18px 0;
      font-size: 14px; line-height: 1.6; border: 1px solid rgba(255,255,255,0.1);
    }

    footer {
      text-align: center; padding: 40px 5%; background: rgba(10, 14, 39, 0.8);
      border-top: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 1;
    }
    footer p { color: #666; font-size: 14px; }

    @media (max-width: 768px) {
      nav { padding: 15px 5%; }
      .nav-links { display: none; }
      .menu-toggle { display: block; }
      .nav-links.active {
        display: flex; flex-direction: column; position: absolute;
        top: 70px; left: 0; right: 0; background: rgba(10, 14, 39, 0.98);
        padding: 20px; gap: 20px;
      }
      .hero { padding: 120px 5% 60px; }
      .hero h1 { font-size: 32px; }
      .features { grid-template-columns: 1fr; }
      .app-container { padding: 30px 25px; }
      .cta-btn { font-size: 18px; padding: 16px 40px; }
    }

    @media (max-width: 480px) {
      .app-container { padding: 25px 20px; }
      .comm-types { grid-template-columns: 1fr; }
      .comm-type { padding: 15px; }
      input, select, button { font-size: 14px; padding: 14px 16px; }
    }
  </style>
      @media (max-width: 480px) {
      .app-container { padding: 25px 20px; }
      .comm-types { grid-template-columns: 1fr; }
      .comm-type { padding: 15px; }
      input, select, button { font-size: 14px; padding: 14px 16px; }
    }
  </style>

  <!-- CLICKABLE FIX: All buttons work, banners don't block -->
  <style>
    /* === CLICKABLE FIX ‚Äî DO NOT DELETE === */
    button, select, input, [onclick], .btn, .nav-cta, .cta-btn, .feature-card, .comm-type, .close-btn, .modal, .modal *, #live-users-counter, #pwa-banner {
      position: relative !important;
      z-index: 1000 !important;
      pointer-events: auto !important;
      cursor: pointer !important;
    }

    #pwa-banner, #live-users-counter {
      pointer-events: none;
      z-index: 100 !important;
    }

    #pwa-banner button, #live-users-counter button {
      pointer-events: auto !important;
      z-index: 1001 !important;
    }

    .app-container, #login-screen, #setup-screen, #video-container, #chat-container {
      z-index: 500 !important;
      position: relative !important;
    }
  </style>
</head>
<body>
  <div class="bg-animated"></div>

  <nav>
    <div class="logo" id="logoBtn">HostelHub</div>
    <div class="menu-toggle" id="menuToggle">‚ò∞</div>
    <div class="nav-links" id="navLinks">
      <a id="featuresLink">Features</a>
      <a id="aboutLink">About</a>
      <button class="nav-cta" id="navGetStarted">Get Started</button>
    </div>
  </nav>

  <section class="hero">
    <h1>Connect with College Students Anonymously</h1>
    <p>Video chat, voice call, or text with students from your college. Safe, anonymous, and fun. Just like Omegle, but for verified college students only.</p>
    <button class="cta-btn" id="heroStartBtn">Start Matching Now ‚Üí</button>
  </section>

  <section class="features" id="features">
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">üìπ</div>
      <h3>Video & Voice</h3>
      <p>High-quality video calls or voice-only chats with crystal clear audio</p>
    </div>
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">üé≠</div>
      <h3>Anonymous Matching</h3>
      <p>Connect randomly with verified students from your college while staying anonymous</p>
    </div>
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">üí¨</div>
      <h3>Text Chat</h3>
      <p>Prefer typing? Use our instant text chat with auto-save feature</p>
    </div>
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">üõ°Ô∏è</div>
      <h3>Safe & Secure</h3>
      <p>Report/block features, no personal info shared, email verification required</p>
    </div>
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">‚è≠Ô∏è</div>
      <h3>Skip Anytime</h3>
      <p>Not feeling the vibe? Skip to the next person instantly, Omegle-style</p>
    </div>
    <div class="feature-card" data-action="openApp">
      <div class="feature-icon">üéØ</div>
      <h3>Interest Matching</h3>
      <p>Add interests and find people with similar hobbies and passions</p>
    </div>
  </section>

  <section class="cta-section" id="cta-section">
    <h2 style="font-size: clamp(32px, 5vw, 42px); margin-bottom: 20px;">Ready to make new friends?</h2>
    <p style="color: #888; margin-bottom: 40px; font-size: clamp(16px, 2vw, 18px);">Join thousands of students connecting daily</p>
    <button class="cta-btn" id="ctaLaunchBtn">Launch HostelHub ‚Üí</button>
  </section>

  <footer>
    <p>&copy; 2024 HostelHub. All rights reserved. Made with ‚ù§Ô∏è for college students.</p>
  </footer>

  <div id="appModal" class="app-modal">
    <div class="app-container">
      <button class="close-btn" id="closeAppBtn">√ó</button>
      
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 32px; margin-bottom: 10px;">HostelHub</h1>
        <p class="subtitle">Connect with students anonymously</p>
      </div>

      <div id="login-screen" class="screen active">
        <input id="email" type="email" placeholder="your.email@gmail.com" />
        <input id="password" type="password" placeholder="Password (6+ characters)" />
        
        <button id="signupBtn">Sign Up</button>
        <button id="loginBtn" class="btn-secondary">Login</button>
        <button id="forgotPasswordBtn" class="btn-secondary" style="font-size: 13px; padding: 12px;">Forgot Password?</button>
        
        <div class="verify-notice" style="display: none;" id="verify-notice">
          ‚úâÔ∏è Verification email sent! Check your inbox and click the link, then return here to login.
        </div>
        
        <div class="verify-notice" style="display: none;" id="reset-notice">
          üìß Password reset email sent! Check your inbox.
        </div>
        
        <div class="safety-note">
          üîí Works with any email ‚Ä¢ Anonymous matching ‚Ä¢ No personal info shared
        </div>
      </div>

      <div id="setup-screen" class="screen">
        <p class="subtitle">Logged in as: <span id="user-email"></span></p>
        
        <div class="interests-label">Choose Communication Type:</div>
        <div class="comm-types">
          <div class="comm-type active" data-type="video">
            <div class="comm-type-icon">üìπ</div>
            <div class="comm-type-label">Video</div>
          </div>
          <div class="comm-type" data-type="voice">
            <div class="comm-type-icon">üé§</div>
            <div class="comm-type-label">Voice</div>
          </div>
          <div class="comm-type" data-type="chat">
            <div class="comm-type-icon">üí¨</div>
            <div class="comm-type-label">Chat</div>
          </div>
        </div>
        
        <select id="gender">
          <option value="">Select your gender</option>
          <option value="men">Men</option>
          <option value="women">Women</option>
          <option value="other">Other</option>
        </select>

        <select id="college">
          <option value="">Select your college</option>
          <option value="IIT Delhi">IIT Delhi</option>
          <option value="IIT Bombay">IIT Bombay</option>
          <option value="JNTUK">JNTUK</option>
          <option value="KL University">KL University</option>
          <option value="VIT AP">VIT AP</option>
          <option value="Delhi University">Delhi University</option>
          <option value="Other">Other</option>
          <option value="ANY">üåç Match with Anyone (Testing)</option>
        </select>
        
        <div class="interests-section">
          <div class="interests-label">Add interests (optional - max 5):</div>
          <div class="interests-input">
            <input id="interest-input" type="text" placeholder="e.g., cricket, coding, music" maxlength="20" />
            <button id="add-interest-btn">Add</button>
          </div>
          <div class="interest-tags" id="interest-tags"></div>
        </div>

        <button id="findBtn">üîç Find Match</button>
        <button id="logoutBtn" class="btn-secondary">Logout</button>
        
        <div class="safety-note">
          You'll be matched anonymously with someone from the same college and gender.
          <span class="warning">Never share personal contact info.</span>
        </div>
      </div>

      <div id="status"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

  <script>
    // ===== FIREBASE CONFIGURATION =====
    const firebaseConfig = {
      apiKey: "AIzaSyB_gNArL-vud6HhtWXnwVf6KMAXTRqfAk4",
      authDomain: "hostelhub-b11fd.firebaseapp.com",
      projectId: "hostelhub-b11fd",
      storageBucket: "hostelhub-b11fd.firebasestorage.app",
      messagingSenderId: "935653838481",
      appId: "1:935653838481:web:e65ad37e0f6e91ff3ef930",
      measurementId: "G-KMHEWDN748"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    console.log('‚úÖ Firebase initialized successfully!');

    // ===== STATE VARIABLES =====
    let currentUser = null;
    let commType = 'video';
    let userInterests = [];

    const appModal = document.getElementById('appModal');
    const loginScreen = document.getElementById('login-screen');
    const setupScreen = document.getElementById('setup-screen');
    const statusEl = document.getElementById('status');

    // ===== NAVIGATION FUNCTIONS =====
    function openApp() {
      appModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeApp() {
      appModal.classList.remove('active');
      document.body.style.overflow = '';
    }

    function toggleMenu() {
      document.getElementById('navLinks').classList.toggle('active');
    }

    function scrollToFeatures(e) {
      if (e) e.preventDefault();
      document.getElementById('features').scrollIntoView({ behavior: 'smooth' });
      document.getElementById('navLinks').classList.remove('active');
    }

    function scrollToSection(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
      document.getElementById('navLinks').classList.remove('active');
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ade80' : '#ffd43b';
    }

    function showLoginScreen() {
      loginScreen.classList.add('active');
      setupScreen.classList.remove('active');
      statusEl.textContent = '';
    }

    function showSetupScreen() {
      loginScreen.classList.remove('active');
      setupScreen.classList.add('active');
      if (currentUser) {
        document.getElementById('user-email').textContent = currentUser.email.split('@')[0];
      }
      statusEl.textContent = '';
    }

    // ===== FIREBASE AUTH LISTENER =====
    auth.onAuthStateChanged(async (user) => {
      if (user && user.emailVerified) {
        currentUser = user;
        showSetupScreen();
        console.log('‚úÖ User logged in:', user.email);
      } else if (user && !user.emailVerified) {
        showStatus('Please verify your email first', 'warning');
        setTimeout(() => auth.signOut(), 3000);
      } else {
        currentUser = null;
        showLoginScreen();
      }
    });

    // ===== EVENT LISTENERS =====
    document.getElementById('logoBtn').addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    document.getElementById('menuToggle').addEventListener('click', toggleMenu);
    document.getElementById('featuresLink').addEventListener('click', scrollToFeatures);
    document.getElementById('aboutLink').addEventListener('click', () => scrollToSection('cta-section'));
    document.getElementById('navGetStarted').addEventListener('click', openApp);
    document.getElementById('heroStartBtn').addEventListener('click', openApp);
    document.getElementById('ctaLaunchBtn').addEventListener('click', openApp);
    document.getElementById('closeAppBtn').addEventListener('click', closeApp);

    document.querySelectorAll('.feature-card').forEach(card => {
      card.addEventListener('click', openApp);
    });

    // ===== SIGNUP =====
    document.getElementById('signupBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !email.includes('@')) {
        showStatus('Please enter a valid email', 'error');
        return;
      }

      if (password.length < 6) {
        showStatus('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        showStatus('Creating account...', 'info');
        const result = await auth.createUserWithEmailAndPassword(email, password);
        await result.user.sendEmailVerification();
        
        document.getElementById('verify-notice').style.display = 'block';
        showStatus('Verification email sent! Check your inbox.', 'success');
        
        setTimeout(() => auth.signOut(), 3000);
      } catch (error) {
        console.error('Signup error:', error);
        if (error.code === 'auth/email-already-in-use') {
          showStatus('Email already registered. Try logging in.', 'error');
        } else {
          showStatus('Error: ' + error.message, 'error');
        }
      }
    });

    // ===== LOGIN =====
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showStatus('Please enter email and password', 'error');
        return;
      }

      try {
        showStatus('Logging in...', 'info');
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        console.error('Login error:', error);
        if (error.code === 'auth/user-not-found') {
          showStatus('No account found. Please sign up first.', 'error');
        } else if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-login-credentials') {
          showStatus('Incorrect password. Try "Forgot Password".', 'error');
        } else {
          showStatus('Error: ' + error.message, 'error');
        }
      }
    });

    // ===== FORGOT PASSWORD =====
    document.getElementById('forgotPasswordBtn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();

      if (!email || !email.includes('@')) {
        showStatus('Please enter your email first', 'error');
        return;
      }

      try {
        showStatus('Sending reset email...', 'info');
        await auth.sendPasswordResetEmail(email);
        
        document.getElementById('reset-notice').style.display = 'block';
        showStatus('Password reset email sent!', 'success');
      } catch (error) {
        console.error('Reset error:', error);
        if (error.code === 'auth/user-not-found') {
          showStatus('No account found with this email.', 'error');
        } else {
          showStatus('Error: ' + error.message, 'error');
        }
      }
    });

    // ===== LOGOUT =====
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await auth.signOut();
      showStatus('Logged out successfully', 'success');
    });

    //

    document.getElementById('findBtn').onclick = async () => {
      const gender = document.getElementById('gender').value;
      const college = document.getElementById('college').value;

      if (!gender || !college) {
        showStatus('Please select gender and college', 'error');
        return;
      }

      try {
        showStatus('Finding match...', 'info');
        document.getElementById('findBtn').disabled = true;

        const userId = currentUser.uid;

        await db.collection('waiting').doc(userId).set({
          userId,
          email: currentUser.email,
          college,
          gender,
          commType,
          interests: userInterests,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        await findMatch(userId, college, gender);
      } catch (error) {
        showStatus('Error: ' + error.message, 'error');
        document.getElementById('findBtn').disabled = false;
      }
    };

    async function findMatch(userId, college, gender) {
      let matchCheckCount = 0;
      const maxChecks = 60;
      let attemptedMatch = false;
      
      let query;
      if (college === 'ANY') {
        query = db.collection('waiting').where('commType', '==', commType);
      } else {
        query = db.collection('waiting')
          .where('college', '==', college)
          .where('gender', '==', gender)
          .where('commType', '==', commType);
      }

      matchListener = query.onSnapshot(async (snapshot) => {
        matchCheckCount++;
        
        const users = snapshot.docs.filter(doc => {
          const uid = doc.id;
          return uid !== userId && !blockedUsers.includes(uid);
        });
        
        showStatus(`Finding match... (${users.length} others waiting)`, 'info');
        
        if (users.length > 0 && !attemptedMatch) {
          attemptedMatch = true;
          const matchDoc = users[0];
          remoteUid = matchDoc.id;
          const matchData = matchDoc.data();
          
          callId = [userId, remoteUid].sort().join('_');

          try {
            await Promise.all([
              db.collection('waiting').doc(userId).delete(),
              db.collection('waiting').doc(remoteUid).delete()
            ]);

            if (matchListener) {
              matchListener();
              matchListener = null;
            }

            showStrangerInfo(matchData.interests || []);
            showStatus('Match found! Connecting...', 'success');
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (commType === 'chat') {
              await startChat();
            } else {
              await startCall(userId < remoteUid);
            }

          } catch (error) {
            console.error('Match failed:', error);
            attemptedMatch = false;
            showStatus('Match failed, retrying...', 'warning');
            return;
          }
        } else if (matchCheckCount >= maxChecks) {
          if (matchListener) matchListener();
          await db.collection('waiting').doc(userId).delete().catch(()=>{});
          showStatus('No match found. Please try again.', 'error');
          document.getElementById('findBtn').disabled = false;
        }
      });
    }

    function showStrangerInfo(interests) {
      const commonInterests = interests.filter(i => userInterests.includes(i));
      let infoHTML = `<div>üé≠ Connected with a stranger from ${document.getElementById('college').value}</div>`;
      
      if (commonInterests.length > 0) {
        infoHTML += `<div class="stranger-interests">Common interests: ${commonInterests.map(i => 
          `<span class="tag">${i}</span>`
        ).join('')}</div>`;
      } else if (interests.length > 0) {
        infoHTML += `<div class="stranger-interests">Their interests: ${interests.map(i => 
          `<span class="tag">${i}</span>`
        ).join('')}</div>`;
      }
      
      document.getElementById('stranger-info').innerHTML = infoHTML;
      document.getElementById('stranger-info-chat').innerHTML = infoHTML;
    }

    async function startChat() {
      chatContainer.style.display = 'block';
      setupScreen.style.display = 'none';
      chatHistory = [];
      
      addSystemMessage('Connected! Say hello üëã');
      
      chatListener = db.collection('calls').doc(callId).collection('messages')
        .orderBy('timestamp')
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const msg = change.doc.data();
              if (msg.from !== currentUser.uid) {
                addMessage(msg.text, 'remote');
                chatHistory.push({
                  from: 'Stranger',
                  text: msg.text,
                  time: new Date().toLocaleTimeString()
                });
              }
            }
          });
        });
    }

    document.getElementById('send-btn').onclick = sendMessage;
    chatInput.onkeypress = (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    };

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      if (containsContactInfo(text)) {
        addSystemMessage('‚ö†Ô∏è Sharing contact info is against the rules');
        return;
      }
      
      addMessage(text, 'local');
      chatHistory.push({
        from: 'You',
        text: text,
        time: new Date().toLocaleTimeString()
      });
      chatInput.value = '';
      
      await db.collection('calls').doc(callId).collection('messages').add({
        text,
        from: currentUser.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function containsContactInfo(text) {
      const patterns = [
        /\d{10}/, /\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/,
        /@\w+\.\w+/,
        /instagram|facebook|whatsapp|snapchat|telegram|twitter/i,
        /insta|fb|wa|snap|dm/i
      ];
      return patterns.some(pattern => pattern.test(text));
    }

    function addMessage(text, type) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.textContent = text;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addSystemMessage(text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message system';
      msgDiv.textContent = text;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function startCall(isInitiator) {
      try {
        const constraints = commType === 'video' 
          ? { video: { inline-size: 640, block-size: 480 }, audio: true }
          : { video: false, audio: true };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        
        if (commType === 'voice') {
          localVideo.style.display = 'none';
          remoteVideo.style.display = 'none';
        } else {
          localVideo.style.display = '';
          remoteVideo.style.display = '';
        }

        pc = new RTCPeerConnection({
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            {
              urls: 'turn:openrelay.metered.ca:80',
              username: 'openrelayproject',
              credential: 'openrelayproject'
            },
            {
              urls: 'turn:openrelay.metered.ca:443',
              username: 'openrelayproject',
              credential: 'openrelayproject'
            }
          ]
        });

        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.ontrack = (event) => {
          if (event.streams && event.streams[0]) {
            remoteVideo.srcObject = event.streams[0];
            remoteVideo.play().catch(e => console.error('Video play error:', e));
            showStatus('Connected!', 'success');
          }
        };

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            db.collection('calls').doc(callId).collection('candidates').add({
              candidate: event.candidate.toJSON(),
              from: currentUser.uid,
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error('Error adding candidate:', e));
          }
        };

        pc.onconnectionstatechange = () => {
          updateConnectionQuality(pc.connectionState);
        };

        candidateListener = db.collection('calls').doc(callId).collection('candidates')
          .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
              if (change.type === 'added') {
                const data = change.doc.data();
                if (data.from !== currentUser.uid) {
                  try {
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                  } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                  }
                }
              }
            });
          });

        callListener = db.collection('calls').doc(callId).onSnapshot(async (snap) => {
          const data = snap.data();
          if (!data) return;

          if (!isInitiator && data.offer && !pc.currentRemoteDescription) {
            try {
              await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              await db.collection('calls').doc(callId).update({
                answer: { type: answer.type, sdp: answer.sdp }
              });
            } catch (err) {
              console.error('Error handling offer:', err);
            }
          }

          if (isInitiator && data.answer && !pc.currentRemoteDescription) {
            try {
              await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            } catch (err) {
              console.error('Error setting answer:', err);
            }
          }
        });

        if (isInitiator) {
          const offer = await pc.createOffer();
          await pc.setLocalDescription(offer);
          await db.collection('calls').doc(callId).set({
            offer: { type: offer.type, sdp: offer.sdp },
            initiator: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        showVideoScreen();
      } catch (error) {
        console.error('startCall error:', error);
        showStatus('Error accessing camera/mic: ' + error.message, 'error');
        await cleanup();
      }
    }

    document.getElementById('muteBtn').onclick = () => {
      if (!localStream) return;
      isAudioMuted = !isAudioMuted;
      localStream.getAudioTracks().forEach(track => track.enabled = !isAudioMuted);
      document.getElementById('muteBtn').textContent = isAudioMuted ? 'üîä Unmute' : 'üîá Mute';
    };

    document.getElementById('videoBtn').onclick = () => {
      if (!localStream) return;
      isVideoOff = !isVideoOff;
      localStream.getVideoTracks().forEach(track => track.enabled = !isVideoOff);
      document.getElementById('videoBtn').textContent = isVideoOff ? 'üìπ On' : 'üìπ Off';
    };

    document.getElementById('skipBtn').onclick = skipMatch;
    document.getElementById('skipBtnChat').onclick = skipMatch;

    async function skipMatch() {
      showStatus('Finding new match...', 'info');
      await cleanup();
      document.getElementById('findBtn').click();
    }

    document.getElementById('endCall').onclick = async () => {
      await cleanup();
      showSetupScreen();
    };
    
    document.getElementById('endChat').onclick = async () => {
      await cleanup();
      showSetupScreen();
    };

    async function cleanup() {
      if (matchListener) { try { matchListener(); } catch(e){} matchListener = null; }
      if (callListener) { try { callListener(); } catch(e){} callListener = null; }
      if (candidateListener) { try { candidateListener(); } catch(e){} candidateListener = null; }
      if (chatListener) { try { chatListener(); } catch(e){} chatListener = null; }
      
      if (pc) {
        try { pc.close(); } catch(e){}
        pc = null;
      }
      
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      
      if (currentUser) {
        try {
          await db.collection('waiting').doc(currentUser.uid).delete().catch(()=>{});
          
          if (callId) {
            const callRef = db.collection('calls').doc(callId);
            const candidatesSnap = await callRef.collection('candidates').get();
            await Promise.all(candidatesSnap.docs.map(d => d.ref.delete()));
            
            const messagesSnap = await callRef.collection('messages').get();
            await Promise.all(messagesSnap.docs.map(d => d.ref.delete()));
            
            await callRef.delete().catch(()=>{});
          }
        } catch (error) {
          console.error('Cleanup error:', error);
        }
      }
      
      callId = null;
      remoteUid = null;
      isAudioMuted = false;
      isVideoOff = false;
      chatMessages.innerHTML = '';
      chatHistory = [];
      document.getElementById('findBtn').disabled = false;
    }

    function updateConnectionQuality(state) {
      const qualityEl = document.getElementById('quality');
      
      switch(state) {
        case 'connected':
          qualityEl.textContent = 'Connected ‚úì';
          qualityEl.className = 'quality-good';
          break;
        case 'connecting':
          qualityEl.textContent = 'Connecting...';
          qualityEl.className = 'quality-fair';
          break;
        case 'disconnected':
        case 'failed':
          qualityEl.textContent = 'Connection lost';
          qualityEl.className = 'quality-poor';
          showStatus('Connection lost. Please skip or end call.', 'error');
          break;
      }
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ade80' : '#ffd43b';
    }

    function showLoginScreen() {
      loginScreen.classList.add('active');
      setupScreen.classList.remove('active');
      videoContainer.style.display = 'none';
      chatContainer.style.display = 'none';
      statusEl.textContent = '';
    }

    function showSetupScreen() {
      loginScreen.classList.remove('active');
      setupScreen.classList.add('active');
      videoContainer.style.display = 'none';
      chatContainer.style.display = 'none';
      document.getElementById('user-email').textContent = currentUser.email.split('@')[0];
      statusEl.textContent = '';
    }

    function showVideoScreen() {
      setupScreen.classList.remove('active');
      videoContainer.style.display = 'block';
      chatContainer.style.display = 'none';
      statusEl.textContent = '';
    }

    window.addEventListener('beforeunload', cleanup);

    // === LIVE USERS COUNTER ===
    let statusRef = null;

    function trackOnline() {
      if (!currentUser) return;
      const uid = currentUser.uid;
      statusRef = db.collection('status').doc(uid);
      statusRef.set({
        online: true,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        email: currentUser.email.split('@')[0]
      }, { merge: true });
    }

    function trackOffline() {
      if (statusRef) {
        statusRef.update({ 
          online: false,
          lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(() => {});
      }
    }

    // Update auth listener to include tracking
    const originalAuthHandler = auth.onAuthStateChanged;
    auth.onAuthStateChanged(async (user) => {
      if (user && user.emailVerified) {
        currentUser = user;
        trackOnline();
        showLiveUsersCounter();
        await loadUserProfile();
        showSetupScreen();
      } else if (user && !user.emailVerified) {
        trackOffline();
        showStatus('Please verify your email first', 'warning');
        setTimeout(() => auth.signOut(), 3000);
      } else {
        trackOffline();
        showLoginScreen();
      }
    });

    window.addEventListener('beforeunload', trackOffline);
    window.addEventListener('unload', trackOffline);

    function showLiveUsersCounter() {
      db.collection('status')
        .where('online', '==', true)
        .onSnapshot(snap => {
          const count = snap.size;
          let counter = document.getElementById('live-users-counter');
          if (!counter) {
            counter = document.createElement('div');
            counter.id = 'live-users-counter';
            counter.style.cssText = `
              position: fixed; inset-block-start: 80px; inset-inline-end: 20px; 
              background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: white; 
              padding: 10px 18px; border-radius: 25px; 
              font-size: 13px; font-weight: 600;
              z-index: 100; box-shadow: 0 4px 15px rgba(0,210,255,0.3);
              backdrop-filter: blur(10px);
              animation: fadeIn 0.5s ease;
              pointer-events: none;
            `;
            document.body.appendChild(counter);
          }
          counter.innerHTML = `üü¢ ${count} online`;
        });
    }

    // === PWA INSTALL PROMPT ===
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // Show PWA banner 5 seconds after login
    const showPWAPrompt = () => {
      setTimeout(() => {
        if (deferredPrompt && !document.getElementById('pwa-banner')) {
          showInstallBanner();
        }
      }, 5000);
    };

    function showInstallBanner() {
      const banner = document.createElement('div');
      banner.id = 'pwa-banner';
      banner.style.cssText = `
        position: fixed; inset-block-end: 20px; inset-inline-start: 50%; transform: translateX(-50%);
        background: rgba(26, 31, 58, 0.95); backdrop-filter: blur(20px);
        color: white; padding: 15px 25px; border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
        font-size: 14px; display: flex; align-items: center; gap: 15px;
        animation: slideUp 0.5s ease-out; max-inline-size: 90%; border: 1px solid rgba(255,255,255,0.1);
      `;
      banner.innerHTML = `
        <span>üì± Add HostelHub to Home Screen</span>
        <button onclick="installPWA()" style="background: linear-gradient(135deg, #00d2ff, #3a7bd5); border: none; color: white; padding: 10px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; pointer-events: auto;">
          Install
        </button>
        <button onclick="this.parentElement.remove()" style="background: transparent; border: none; color: #aaa; cursor: pointer; font-size: 20px; pointer-events: auto;">√ó</button>
      `;
      document.body.appendChild(banner);
    }

    window.installPWA = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      deferredPrompt = null;
      document.getElementById('pwa-banner')?.remove();
    };

    // Trigger PWA prompt when user logs in
    document.getElementById('loginBtn').addEventListener('click', () => {
      setTimeout(showPWAPrompt, 1000);
    });

    // Add animation styles
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      @keyframes slideUp {
        from { transform: translate(-50%, 100%); opacity: 0; }
        to { transform: translateX(-50%); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
