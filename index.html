<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HostelHub</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0f0f1a; color: #fff; font-family: 'Inter', sans-serif;
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 20px;
    }
    .container {
      background: #1a1a2e; border-radius: 24px; padding: 40px 30px;
      width: 100%; max-width: 420px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      text-align: center; border: 1px solid #333;
    }
    h1 { font-size: 28px; margin-bottom: 8px; background: linear-gradient(135deg, #00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    p { color: #aaa; font-size: 14px; margin-bottom: 30px; }
    input, select, button {
      width: 100%; padding: 14px; margin: 10px 0; border-radius: 12px;
      font-size: 16px; border: 1px solid #333; background: #16213e; color: #fff;
    }
    select { cursor: pointer; }
    button {
      background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      border: none; font-weight: 600; cursor: pointer; transition: 0.3s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,210,255,0.3); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 20px; font-size: 15px; min-height: 24px; color: #ffd43b; }
    #video-container { display: none; margin-top: 20px; }
    #videos { display: flex; flex-direction: column; gap: 10px; }
    #local-video, #remote-video {
      width: 100%; height: 250px; background: #000; border-radius: 16px; object-fit: cover;
    }
    #local-video { height: 120px; border: 2px solid #00d2ff; }
    #endCall { background: #ff6b6b; margin-top: 15px; }
    .college-tag { background: #4ade80; color: #000; padding: 4px 8px; border-radius: 8px; font-size: 14px; margin-top: 10px; display: none; }
    .safety-note { font-size: 12px; color: #ff6b6b; margin-top: 5px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>HostelHub</h1>
    <p>One-on-one video chat with same college + gender</p>

    <input id="email" type="email" placeholder="you@iitd.ac.in" />
    <div id="college-display" class="college-tag"></div>

    <select id="gender">
      <option value="">Your gender</option>
      <option value="men">Men</option>
      <option value="women">Women</option>
    </select>

    <select id="hostel">
      <option value="">Select your hostel</option>
      <option value="Ramanujan">Ramanujan (IIT Delhi)</option>
      <option value="Kumaon">Kumaon (IIT Delhi)</option>
    </select>

    <button id="findBtn">Find One-on-One Match</button>
    <div class="safety-note">No phone numbers/emails in chat â€” reported automatically</div>
    <div id="status"></div>

    <div id="video-container">
      <div id="videos">
        <video id="local-video" autoplay playsinline muted></video>
        <video id="remote-video" autoplay playsinline></video>
      </div>
      <button id="endCall">End Call</button>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB_gNArL-vud6HhtWXNwVf6KMAXTRqfAK4",
      authDomain: "hostelhub-b11fd.firebaseapp.com",
      projectId: "hostelhub-b11fd",
      storageBucket: "hostelhub-b11fd.firebasestorage.app",
      messagingSenderId: "935653838481",
      appId: "1:935653838481:web:e65ad37e0f6e91ff3ef930"
    };

    const collegeMap = { 'iitd.ac.in': 'IIT Delhi', 'du.ac.in': 'Delhi University' };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let localUid = null, remoteUid = null;
    let pc = null, localStream = null;
    let callId = null;

    const statusEl = document.getElementById('status');
    const findBtn = document.getElementById('findBtn');
    const videoContainer = document.getElementById('video-container');
    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');

    document.getElementById('email').oninput = () => {
      const email = document.getElementById('email').value.trim();
      const domain = email.split('@')[1];
      const college = collegeMap[domain];
      const display = document.getElementById('college-display');
      display.textContent = college || '';
      display.style.display = college ? 'block' : 'none';
    };

    findBtn.onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const gender = document.getElementById('gender').value;
      const hostel = document.getElementById('hostel').value;

      if (!email.endsWith('.ac.in') || !gender || !hostel) {
        statusEl.textContent = "Fill all fields";
        statusEl.style.color = "#ff6b6b";
        return;
      }

      statusEl.textContent = "Finding match...";
      findBtn.disabled = true;

      localUid = email;
      const domain = email.split('@')[1];
      const college = collegeMap[domain] || domain;

      await db.collection('users').doc(localUid).set({
        email, college, gender, hostel, available: true
      });

      const match = await waitForMatch(email, college, gender, hostel);
      if (match) {
        remoteUid = match.id;
        callId = [localUid, remoteUid].sort().join('_');
        statusEl.textContent = `Connected with ${match.data().email.split('@')[0]}`;
        statusEl.style.color = "#4ade80";
        await startCall();
      }
    };

    async function waitForMatch(email, college, gender, hostel) {
      return new Promise(resolve => {
        const unsub = db.collection('users')
          .where('available', '==', true)
          .onSnapshot(async snap => {
            for (let doc of snap.docs) {
              if (doc.id !== email && doc.data().gender === gender && doc.data().hostel === hostel) {
                await doc.ref.update({ available: false });
                await db.collection('users').doc(email).update({ available: false });
                unsub();
                resolve(doc);
                return;
              }
            }
          });
      });
    }

    async function startCall() {
      videoContainer.style.display = 'block';

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      });

      // Get camera & mic
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localVideo.srcObject = localStream;

      // Remote stream
      pc.ontrack = (event) => {
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          console.log('Remote stream received');
        }
      };

      // ICE candidates
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          db.collection('calls').doc(callId).collection('candidates').add({
            ...event.candidate.toJSON(),
            from: localUid
          });
        }
      };

      // Create offer if initiator
      const isInitiator = localUid < remoteUid;
      if (isInitiator) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await db.collection('calls').doc(callId).set({ offer });
      }

      // Listen for offer
      db.collection('calls').doc(callId).onSnapshot(async (snap) => {
        const data = snap.data();
        if (!pc.currentRemoteDescription && data?.offer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          await db.collection('calls').doc(callId).update({ answer });
        }
        if (!pc.currentRemoteDescription && data?.answer) {
          await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
        }
      });

      // Listen for ICE
      db.collection('calls').doc(callId).collection('candidates').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          if (change.type === 'added') {
            const data = change.doc.data();
            if (data.from !== localUid) {
              pc.addIceCandidate(new RTCIceCandidate(data));
            }
          }
        });
      });
    }

    window.endCall = async () => {
      if (pc) pc.close();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      if (localUid) await db.collection('users').doc(localUid).delete();
      if (callId) await db.collection('calls').doc(callId).delete();
      location.reload();
    };
  </script>
</body>
</html>
